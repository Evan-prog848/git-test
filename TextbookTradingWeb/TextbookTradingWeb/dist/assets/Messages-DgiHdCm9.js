import{_ as F,o as P,a as j,b as v,c as _,e as p,w as x,r as I,i as g,L as q,a0 as K,d as i,F as V,B as A,n as B,t as y,f as H,g as $,u as G,h as J,l as Q}from"./index-Bc-dwE5O.js";import{u as W}from"./user-BS79HK15.js";import{s as z}from"./request-bgZeUyhp.js";import"./auth-BBsyecEI.js";const X=M=>z.post("/message/send",M),L=M=>z.get("/message/list",{params:M}),Y={class:"container messages-page"},Z={class:"messages-layout"},ee={class:"message-list"},te=["onClick"],se={class:"contact-info"},ae={class:"name-time"},ne={class:"nickname"},oe={class:"time"},re={class:"last-msg"},ie={key:0,class:"chat-box"},ce={class:"chat-header"},le={class:"msg-content"},de={class:"msg-text"},ue={class:"msg-time"},ve={class:"chat-input"},me={class:"input-actions"},fe={key:1,class:"chat-placeholder"},_e=3e3,pe={__name:"Messages",setup(M){const U=q(),l=W(),c=g(null),T=g(""),k=g(null),N=g(!1),m=g([]),f=g([]);let w=null;const E=async()=>{N.value=!0;try{const a=(await L({pageNum:1,pageSize:100})).data.records||[],n={};a.forEach(t=>{const r=t.fromUserId===l.userInfo.id?t.toUserId:t.fromUserId;n[r]||(n[r]={id:r,nickname:t.fromUserId===l.userInfo.id?t.toNickname:t.fromUserName,avatar:t.fromUserId===l.userInfo.id?t.toAvatar:t.fromUserAvatar,lastMsg:t.content,lastTime:t.createTime,unreadCount:0,messages:[]}),n[r].messages.push(t)}),m.value=Object.values(n),U.query.userId&&S(U.query)}catch{U.query.userId&&S(U.query)}finally{N.value=!1}},b=o=>{c.value=o;const a=[...o.messages].sort((n,t)=>{const r=new Date(n.createTime).getTime(),s=new Date(t.createTime).getTime();return r-s});o.messages=a,f.value=a.map(n=>({id:n.id,text:n.content,time:n.createTime,isMine:n.fromUserId===l.userInfo.id})),C()},D=async()=>{if(!T.value.trim()||!c.value)return;const o=T.value;try{await X({toUserId:c.value.id,content:o,type:0});const a={id:Date.now(),content:o,createTime:new Date().toISOString(),fromUserId:l.userInfo.id,toUserId:c.value.id};c.value.messages.push(a),c.value.lastMsg=o,c.value.lastTime="刚刚",f.value.push({id:a.id,text:o,time:a.createTime,isMine:!0}),f.value.sort((n,t)=>new Date(n.time).getTime()-new Date(t.time).getTime()),T.value="",C()}catch{}},C=()=>{K(()=>{k.value&&(k.value.scrollTop=k.value.scrollHeight)})},O=()=>{w=setInterval(async()=>{var o;try{const n=(await L({pageNum:1,pageSize:100})).data.records||[];if(c.value){const s=c.value.id,d=n.filter(h=>{const e=h.fromUserId===s,u=h.toUserId===l.userInfo.id;return e&&u});if(d.length>0){const h=new Set(f.value.map(e=>e.id));d.forEach(e=>{h.has(e.id)||f.value.push({id:e.id,text:e.content,time:e.createTime,isMine:!1})}),f.value.sort((e,u)=>new Date(e.time).getTime()-new Date(u.time).getTime()),C()}}const t={};n.forEach(s=>{const d=s.fromUserId===l.userInfo.id?s.toUserId:s.fromUserId;t[d]||(t[d]={id:d,nickname:s.fromUserId===l.userInfo.id?s.toNickname:s.fromUserName,avatar:s.fromUserId===l.userInfo.id?s.toAvatar:s.fromUserAvatar,lastMsg:s.content,lastTime:s.createTime,unreadCount:0,messages:[]}),t[d].messages.push(s)});const r=(o=c.value)==null?void 0:o.id;m.value=Object.values(t),r&&(c.value=m.value.find(s=>s.id===r)||null)}catch{}},_e)},R=()=>{w&&(clearInterval(w),w=null)};P(()=>{E(),O()}),j(()=>{R()});const S=o=>{const a=parseInt(o.userId),n=o.nickname||"用户",t=o.avatar||"";let r=m.value.find(s=>s.id===a);r||(r={id:a,nickname:n,avatar:t,lastMsg:"",lastTime:"",unreadCount:0,messages:[]},m.value.unshift(r)),b(r)};return(o,a)=>{const n=I("el-avatar"),t=I("el-badge"),r=I("el-empty"),s=I("el-input"),d=I("el-button"),h=I("el-card");return v(),_("div",Y,[p(h,{class:"messages-card","body-style":{padding:"0px"}},{default:x(()=>[i("div",Z,[i("div",ee,[a[1]||(a[1]=i("div",{class:"list-header"},[i("h3",null,"消息中心")],-1)),(v(!0),_(V,null,A(m.value,e=>{var u;return v(),_("div",{key:e.id,class:B(["contact-item",{active:((u=c.value)==null?void 0:u.id)===e.id}]),onClick:he=>b(e)},[p(t,{value:e.unreadCount,hidden:e.unreadCount===0},{default:x(()=>[p(n,{size:40,src:e.avatar},null,8,["src"])]),_:2},1032,["value","hidden"]),i("div",se,[i("div",ae,[i("span",ne,y(e.nickname),1),i("span",oe,y(e.lastTime),1)]),i("div",re,y(e.lastMsg),1)])],10,te)}),128)),m.value.length===0?(v(),H(r,{key:0,description:"暂无消息","image-size":60})):$("",!0)]),c.value?(v(),_("div",ie,[i("div",ce,[i("span",null,y(c.value.nickname),1)]),i("div",{class:"chat-messages",ref_key:"chatMsgRef",ref:k},[(v(!0),_(V,null,A(f.value,(e,u)=>(v(),_("div",{key:u,class:B(["msg-item",{"msg-mine":e.isMine}])},[p(n,{size:32,src:e.isMine?G(l).userInfo.avatar:c.value.avatar},null,8,["src"]),i("div",le,[i("div",de,y(e.text),1),i("div",ue,y(e.time),1)])],2))),128))],512),i("div",ve,[p(s,{modelValue:T.value,"onUpdate:modelValue":a[0]||(a[0]=e=>T.value=e),type:"textarea",rows:3,placeholder:"请输入消息内容...",onKeyup:J(D,["enter","native"])},null,8,["modelValue"]),i("div",me,[p(d,{type:"primary",onClick:D},{default:x(()=>[...a[2]||(a[2]=[Q("发送",-1)])]),_:1})])])])):(v(),_("div",fe,[p(r,{description:"选择一个联系人开始聊天"})]))])]),_:1})])}}},Me=F(pe,[["__scopeId","data-v-71e4ec1a"]]);export{Me as default};
