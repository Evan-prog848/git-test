import{_ as te,K as S,H as se,o as re,b as _,c as h,e,w as o,r,j as ne,d as f,u as m,t as C,f as F,l as g,g as y,V as de,W as ue,X as ie,Y as me,i as E,P as w,Z as ce,O as fe}from"./index-Bc-dwE5O.js";import{u as pe}from"./user-BS79HK15.js";import{u as _e,a as we}from"./user-nO6ITqrd.js";import{b as ve}from"./textbook-Pf6eG0Sa.js";import{s as T}from"./request-bgZeUyhp.js";import"./auth-BBsyecEI.js";const ge={class:"container user-center-page"},ye={class:"user-brief"},be={class:"nickname"},Ve={class:"card-header"},Pe={key:0},ke=["src"],he={key:1},Ie={key:2},xe={key:3},Ce={class:"book-cell"},Ue={class:"book-name"},z="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",Se={__name:"UserCenter",setup(Fe){const A=ne(),s=pe(),v=E("profile"),b=E(null),D=fe(()=>({profile:"个人信息",security:"账号安全",verification:"学校认证","my-posts":"我的发布"})[v.value]),n=S({username:s.userInfo.username,nickname:s.userInfo.nickname,avatar:s.userInfo.avatar,phone:s.userInfo.phone||"",email:s.userInfo.email||""}),i=S({oldPassword:"",newPassword:"",confirmPassword:""}),N={oldPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请再次输入新密码",trigger:"blur"},{validator:(l,a,d)=>{a===""?d(new Error("请再次输入新密码")):a!==i.newPassword?d(new Error("两次输入密码不一致")):d()},trigger:"change"}]},c=S({school:s.userInfo.school||"",college:s.userInfo.college||"",major:s.userInfo.major||""}),j=E([]),q=l=>{v.value=l,l==="my-posts"&&B()};se(()=>i.newPassword,()=>{b.value&&i.confirmPassword&&b.value.validateField("confirmPassword")});const $=l=>{l.target.src=z},H=async l=>{const a=new FileReader;a.onload=d=>{n.avatar=d.target.result},a.readAsDataURL(l.raw);try{const d=new FormData;d.append("file",l.raw),d.append("type","avatar");const V=await T.post("/file/upload",d,{headers:{"Content-Type":"multipart/form-data"}});V.data&&(n.avatar=V.data,w.success("头像上传成功"))}catch(d){console.error("Avatar upload error:",d),w.error("头像上传失败: "+(d.message||"未知错误"))}},B=async()=>{try{const l=await ve({pageNum:1,pageSize:100});j.value=l.data.records}catch{}},K=l=>l.auditStatus===0?"审核中":l.auditStatus===2?"审核拒绝":{0:"已下架",1:"在售中",2:"已售出"}[l.status],L=l=>l.auditStatus===0?"warning":l.auditStatus===2?"danger":{0:"info",1:"success",2:"warning"}[l.status],O=async()=>{try{await _e(n),w.success("信息修改成功"),s.setUserInfo({...s.userInfo,...n})}catch{}},W=async()=>{b.value&&b.value.validate(async l=>{if(l)try{await we({oldPassword:i.oldPassword,newPassword:i.newPassword,confirmPassword:i.confirmPassword}),w.success("密码修改成功"),b.value.resetFields()}catch(a){w.error(a.message||"密码修改失败")}})},X=()=>{w.success("认证申请已提交，请等待审核"),s.setUserInfo({...s.userInfo,...c,isVerified:!0})},Y=l=>{A.push({path:"/publish",query:{id:l.id}})},Z=async l=>{try{await ce.confirm("确定要删除这条发布吗？","提示",{type:"warning"}),await T.delete(`/textbook/${l.id}`),w.success("删除成功"),B()}catch(a){a!=="cancel"&&w.error("删除失败")}};return re(()=>{s.userInfo.isVerified&&(c.school=s.userInfo.school,c.college=s.userInfo.college,c.major=s.userInfo.major)}),(l,a)=>{const d=r("el-avatar"),V=r("el-tag"),I=r("el-icon"),x=r("el-menu-item"),G=r("el-menu"),M=r("el-card"),R=r("el-col"),J=r("el-upload"),u=r("el-form-item"),p=r("el-input"),P=r("el-button"),U=r("el-form"),Q=r("el-alert"),ee=r("el-image"),k=r("el-table-column"),ae=r("el-table"),oe=r("el-row");return _(),h("div",ge,[e(oe,{gutter:20},{default:o(()=>[e(R,{span:6},{default:o(()=>[e(M,{class:"menu-card","body-style":{padding:"0px"}},{default:o(()=>[f("div",ye,[e(d,{size:64,src:m(s).userInfo.avatar||"https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png"},null,8,["src"]),f("div",be,C(m(s).userInfo.nickname),1),m(s).userInfo.isVerified?(_(),F(V,{key:0,size:"small",type:"warning"},{default:o(()=>[...a[10]||(a[10]=[g("已认证",-1)])]),_:1})):y("",!0)]),e(G,{"default-active":v.value,class:"user-menu",onSelect:q},{default:o(()=>[e(x,{index:"profile"},{default:o(()=>[e(I,null,{default:o(()=>[e(m(de))]),_:1}),a[11]||(a[11]=f("span",null,"个人信息",-1))]),_:1}),e(x,{index:"security"},{default:o(()=>[e(I,null,{default:o(()=>[e(m(ue))]),_:1}),a[12]||(a[12]=f("span",null,"账号安全",-1))]),_:1}),e(x,{index:"verification"},{default:o(()=>[e(I,null,{default:o(()=>[e(m(ie))]),_:1}),a[13]||(a[13]=f("span",null,"学校认证",-1))]),_:1}),e(x,{index:"my-posts"},{default:o(()=>[e(I,null,{default:o(()=>[e(m(me))]),_:1}),a[14]||(a[14]=f("span",null,"我的发布",-1))]),_:1})]),_:1},8,["default-active"])]),_:1})]),_:1}),e(R,{span:18},{default:o(()=>[e(M,{class:"content-card"},{header:o(()=>[f("div",Ve,[f("span",null,C(D.value),1)])]),default:o(()=>[v.value==="profile"?(_(),h("div",Pe,[e(U,{model:n,"label-width":"100px",style:{"max-width":"500px"}},{default:o(()=>[e(u,{label:"头像"},{default:o(()=>[e(J,{class:"avatar-uploader",action:"#","show-file-list":!1,"auto-upload":!1,"on-change":H,accept:"image/*"},{default:o(()=>[f("img",{src:n.avatar||z,class:"avatar",onError:$},null,40,ke)]),_:1})]),_:1}),e(u,{label:"用户名"},{default:o(()=>[e(p,{modelValue:n.username,"onUpdate:modelValue":a[0]||(a[0]=t=>n.username=t),disabled:""},null,8,["modelValue"])]),_:1}),e(u,{label:"昵称"},{default:o(()=>[e(p,{modelValue:n.nickname,"onUpdate:modelValue":a[1]||(a[1]=t=>n.nickname=t)},null,8,["modelValue"])]),_:1}),e(u,{label:"手机号"},{default:o(()=>[e(p,{modelValue:n.phone,"onUpdate:modelValue":a[2]||(a[2]=t=>n.phone=t)},null,8,["modelValue"])]),_:1}),e(u,{label:"邮箱"},{default:o(()=>[e(p,{modelValue:n.email,"onUpdate:modelValue":a[3]||(a[3]=t=>n.email=t)},null,8,["modelValue"])]),_:1}),e(u,null,{default:o(()=>[e(P,{type:"primary",onClick:O},{default:o(()=>[...a[15]||(a[15]=[g("保存修改",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])):y("",!0),v.value==="security"?(_(),h("div",he,[e(U,{model:i,rules:N,ref_key:"pwdFormRef",ref:b,"label-width":"100px",style:{"max-width":"500px"}},{default:o(()=>[e(u,{label:"当前密码",prop:"oldPassword"},{default:o(()=>[e(p,{modelValue:i.oldPassword,"onUpdate:modelValue":a[4]||(a[4]=t=>i.oldPassword=t),type:"password","show-password":"",placeholder:"请输入当前密码"},null,8,["modelValue"])]),_:1}),e(u,{label:"新密码",prop:"newPassword"},{default:o(()=>[e(p,{modelValue:i.newPassword,"onUpdate:modelValue":a[5]||(a[5]=t=>i.newPassword=t),type:"password","show-password":"",placeholder:"请输入新密码（至少6位）"},null,8,["modelValue"])]),_:1}),e(u,{label:"确认新密码",prop:"confirmPassword"},{default:o(()=>[e(p,{modelValue:i.confirmPassword,"onUpdate:modelValue":a[6]||(a[6]=t=>i.confirmPassword=t),type:"password","show-password":"",placeholder:"请再次输入新密码"},null,8,["modelValue"])]),_:1}),e(u,null,{default:o(()=>[e(P,{type:"primary",onClick:W},{default:o(()=>[...a[16]||(a[16]=[g("修改密码",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])):y("",!0),v.value==="verification"?(_(),h("div",Ie,[m(s).userInfo.isVerified?(_(),F(Q,{key:0,title:"您已完成学校认证",type:"success",closable:!1,"show-icon":"",style:{"margin-bottom":"20px"}})):y("",!0),e(U,{model:c,"label-width":"100px",style:{"max-width":"500px"}},{default:o(()=>[e(u,{label:"学校"},{default:o(()=>[e(p,{modelValue:c.school,"onUpdate:modelValue":a[7]||(a[7]=t=>c.school=t),disabled:m(s).userInfo.isVerified},null,8,["modelValue","disabled"])]),_:1}),e(u,{label:"学院"},{default:o(()=>[e(p,{modelValue:c.college,"onUpdate:modelValue":a[8]||(a[8]=t=>c.college=t),disabled:m(s).userInfo.isVerified},null,8,["modelValue","disabled"])]),_:1}),e(u,{label:"专业"},{default:o(()=>[e(p,{modelValue:c.major,"onUpdate:modelValue":a[9]||(a[9]=t=>c.major=t),disabled:m(s).userInfo.isVerified},null,8,["modelValue","disabled"])]),_:1}),m(s).userInfo.isVerified?y("",!0):(_(),F(u,{key:0},{default:o(()=>[e(P,{type:"primary",onClick:X},{default:o(()=>[...a[17]||(a[17]=[g("提交认证",-1)])]),_:1})]),_:1}))]),_:1},8,["model"])])):y("",!0),v.value==="my-posts"?(_(),h("div",xe,[e(ae,{data:j.value,style:{width:"100%"}},{default:o(()=>[e(k,{label:"教材",width:"300"},{default:o(t=>[f("div",Ce,[e(ee,{src:t.row.cover,class:"book-img"},null,8,["src"]),f("span",Ue,C(t.row.title),1)])]),_:1}),e(k,{prop:"price",label:"价格",width:"100"}),e(k,{prop:"status",label:"状态",width:"100"},{default:o(t=>[e(V,{type:L(t.row)},{default:o(()=>[g(C(K(t.row)),1)]),_:2},1032,["type"])]),_:1}),e(k,{prop:"createTime",label:"发布时间"}),e(k,{label:"操作",width:"150"},{default:o(t=>[e(P,{size:"small",onClick:le=>Y(t.row)},{default:o(()=>[...a[18]||(a[18]=[g("编辑",-1)])]),_:1},8,["onClick"]),e(P,{size:"small",type:"danger",onClick:le=>Z(t.row)},{default:o(()=>[...a[19]||(a[19]=[g("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])):y("",!0)]),_:1})]),_:1})]),_:1})])}}},Ae=te(Se,[["__scopeId","data-v-20f5c7d4"]]);export{Ae as default};
