import{_ as me,o as ce,b as m,c as b,e as l,w as a,L as fe,i as p,P as v,r,K as ge,j as be,u as h,s as ve,l as n,Q as _e,g as x,d as u,h as Ve,R as ye,t as I,F as N,B,f as T,S as he,U as Ie}from"./index-Bc-dwE5O.js";import{s as L}from"./request-bgZeUyhp.js";import{p as we}from"./textbook-Pf6eG0Sa.js";import{g as ke,q as Ue,s as Ce}from"./common-BUf8eMW3.js";import"./auth-BBsyecEI.js";const Pe={class:"container publish-page"},xe={class:"card-header"},Ne={class:"title"},Be={key:0,class:"input-mode-selector"},Le={key:1,class:"isbn-scan-section"},Se={class:"scan-content"},Me={class:"scan-tip"},qe={key:0,class:"book-preview"},Re=["src"],Fe={class:"book-info"},De={key:0},Ee={class:"condition-checkboxes"},ze={class:"condition-tip"},Te=["src"],$e={__name:"Publish",setup(je){const $=be(),j=fe(),H=p(null),S=p(!1),V=p(!1),M=p(null),q=p(!1),K=p(""),R=p(1),y=p(""),F=p(!1),i=p(null),W=p([]),w=p([]),D=p([]),J=async()=>{try{const s=await L.get("/category/list");s.data&&s.data.length>0?D.value=s.data.filter(e=>!e.parentId||e.parentId===0):O()}catch(s){console.error("Failed to fetch categories:",s),O()}},O=()=>{D.value=[{id:1,name:"计算机"},{id:2,name:"数学"},{id:3,name:"英语"},{id:4,name:"经济管理"},{id:5,name:"机械电子"},{id:6,name:"文学艺术"}]},t=ge({title:"",author:"",publisher:"",isbn:"",categoryId:"",campusId:"",courseId:"",price:0,originalPrice:0,conditionLevel:9,course:"",description:"",images:[],hasNotes:0,hasHighlight:0,hasMissingPages:0,hasWaterStains:0,inputMode:1}),X={title:[{required:!0,message:"请输入书名",trigger:"blur"}],categoryId:[{required:!0,message:"请选择分类",trigger:"change"}],price:[{required:!0,message:"请输入售价",trigger:"blur"}],conditionLevel:[{required:!0,message:"请选择新旧程度",trigger:"change"}]},Y=(s,e)=>{t.images=e},Z=(s,e)=>{t.images=e},ee=s=>{K.value=s.url,q.value=!0},le=async()=>{try{const e=(await L.get(`/textbook/detail/${M.value}`)).data;Object.assign(t,{title:e.title,author:e.author||"",publisher:e.publisher||"",isbn:e.isbn||"",categoryId:e.categoryId,price:e.price,originalPrice:e.originalPrice||0,conditionLevel:e.conditionLevel,course:e.course||"",description:e.description||"",images:[]}),e.cover&&(t.images=[{name:"cover.jpg",url:e.cover,uid:Date.now()}])}catch(s){console.error("加载教材数据失败:",s),v.error("加载教材数据失败"),$.back()}},ae=async()=>{H.value.validate(async s=>{if(s){S.value=!0;try{const e=new FormData;t.images.forEach(c=>{c.raw&&e.append("files",c.raw)});let f=[];e.has("files")?f=(await L.post("/file/uploads",e,{headers:{"Content-Type":"multipart/form-data"}})).data:t.images.length>0&&t.images[0].url&&(f=[t.images[0].url]);const{images:E,...z}=t,_={...z,cover:f[0]||"",images:f};V.value?(_.id=parseInt(M.value),await L.put("/textbook/update",_),v.success("更新成功！")):(await we(_),v.success("发布成功！您的教材正在等待管理员审核，审核通过后将自动上架展示。")),$.push("/profile")}catch(e){console.error("提交失败:",e),v.error(e.message||"操作失败，请稍后重试")}finally{S.value=!1}}})},Q=async()=>{if(!y.value.trim()){v.warning("请输入ISBN号");return}F.value=!0,i.value=null;try{const s=await Ue(y.value.trim());s.code===200&&s.data&&(s.data.success?(i.value=s.data,v.success("查询成功")):v.warning(s.data.errorMessage||"未找到该书籍信息，请手动输入"))}catch(s){console.error("ISBN查询失败:",s),v.error("查询失败，请稍后重试或手动输入")}finally{F.value=!1}},oe=()=>{i.value&&(t.title=i.value.title||"",t.author=i.value.author||"",t.publisher=i.value.publisher||"",t.isbn=i.value.isbn||y.value,t.originalPrice=i.value.originalPrice||0,t.inputMode=1,v.success("已填充书籍信息，请补充其他信息"))},te=s=>{s.target.style.display="none"},se=s=>s?`/api/isbn/proxy-image?url=${encodeURIComponent(s)}`:"",re=async()=>{try{const s=await ke();s.code===200&&(W.value=s.data||[])}catch(s){console.error("加载校区列表失败:",s)}},ne=()=>{t.courseId="",w.value=[]},ue=async s=>{if(!s){w.value=[];return}try{const e=await Ce(s);e.code===200&&(w.value=e.data||[])}catch(e){console.error("搜索课程失败:",e)}};return ce(()=>{J(),re(),j.query.id&&(V.value=!0,M.value=j.query.id,le())}),(s,e)=>{const f=r("el-icon"),E=r("el-radio-button"),z=r("el-radio-group"),_=r("el-button"),c=r("el-input"),A=r("el-card"),d=r("el-form-item"),g=r("el-col"),k=r("el-row"),U=r("el-option"),C=r("el-select"),G=r("el-input-number"),P=r("el-checkbox"),ie=r("el-upload"),de=r("el-dialog"),pe=r("el-form");return m(),b("div",Pe,[l(A,{class:"publish-card"},{header:a(()=>[u("div",xe,[u("span",Ne,I(V.value?"编辑教材":"发布二手教材"),1)])]),default:a(()=>[V.value?x("",!0):(m(),b("div",Be,[l(z,{modelValue:R.value,"onUpdate:modelValue":e[0]||(e[0]=o=>R.value=o),size:"large"},{default:a(()=>[l(E,{label:1},{default:a(()=>[l(f,null,{default:a(()=>[l(h(ve))]),_:1}),e[20]||(e[20]=n(" ISBN扫描录入 ",-1))]),_:1}),l(E,{label:0},{default:a(()=>[l(f,null,{default:a(()=>[l(h(_e))]),_:1}),e[21]||(e[21]=n(" 手动录入 ",-1))]),_:1})]),_:1},8,["modelValue"])])),R.value===1&&!V.value?(m(),b("div",Le,[l(A,{shadow:"never",class:"scan-card"},{default:a(()=>[u("div",Se,[l(c,{modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=o=>y.value=o),placeholder:"请输入或扫描ISBN条码",size:"large",clearable:"",onKeyup:Ve(Q,["enter"])},{prepend:a(()=>[...e[22]||(e[22]=[n("ISBN",-1)])]),append:a(()=>[l(_,{type:"primary",onClick:Q,loading:F.value},{default:a(()=>[...e[23]||(e[23]=[n(" 查询 ",-1)])]),_:1},8,["loading"])]),_:1},8,["modelValue"]),u("div",Me,[l(f,null,{default:a(()=>[l(h(ye))]),_:1}),e[24]||(e[24]=n(" 输入ISBN后点击查询，系统将自动获取书籍信息 ",-1))])]),i.value?(m(),b("div",qe,[u("img",{src:se(i.value.cover),class:"book-cover",onError:te},null,40,Re),u("div",Fe,[u("h3",null,I(i.value.title),1),u("p",null,[e[25]||(e[25]=u("span",null,"作者：",-1)),n(I(i.value.author||"未知"),1)]),u("p",null,[e[26]||(e[26]=u("span",null,"出版社：",-1)),n(I(i.value.publisher||"未知"),1)]),i.value.originalPrice?(m(),b("p",De,[e[27]||(e[27]=u("span",null,"定价：",-1)),n("¥"+I(i.value.originalPrice),1)])):x("",!0),l(_,{type:"primary",size:"small",onClick:oe},{default:a(()=>[...e[28]||(e[28]=[n(" 使用此信息 ",-1)])]),_:1})])])):x("",!0)]),_:1})])):x("",!0),l(pe,{model:t,rules:X,ref_key:"publishFormRef",ref:H,"label-width":"100px",class:"publish-form"},{default:a(()=>[l(d,{label:"教材书名",prop:"title"},{default:a(()=>[l(c,{modelValue:t.title,"onUpdate:modelValue":e[2]||(e[2]=o=>t.title=o),placeholder:"请输入教材完整书名"},null,8,["modelValue"])]),_:1}),l(k,{gutter:20},{default:a(()=>[l(g,{span:12},{default:a(()=>[l(d,{label:"作者",prop:"author"},{default:a(()=>[l(c,{modelValue:t.author,"onUpdate:modelValue":e[3]||(e[3]=o=>t.author=o),placeholder:"请输入作者"},null,8,["modelValue"])]),_:1})]),_:1}),l(g,{span:12},{default:a(()=>[l(d,{label:"出版社",prop:"publisher"},{default:a(()=>[l(c,{modelValue:t.publisher,"onUpdate:modelValue":e[4]||(e[4]=o=>t.publisher=o),placeholder:"请输入出版社"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(k,{gutter:20},{default:a(()=>[l(g,{span:12},{default:a(()=>[l(d,{label:"ISBN",prop:"isbn"},{default:a(()=>[l(c,{modelValue:t.isbn,"onUpdate:modelValue":e[5]||(e[5]=o=>t.isbn=o),placeholder:"请输入ISBN号"},null,8,["modelValue"])]),_:1})]),_:1}),l(g,{span:12},{default:a(()=>[l(d,{label:"教材分类",prop:"categoryId"},{default:a(()=>[l(C,{modelValue:t.categoryId,"onUpdate:modelValue":e[6]||(e[6]=o=>t.categoryId=o),placeholder:"请选择分类",style:{width:"100%"}},{default:a(()=>[(m(!0),b(N,null,B(D.value,o=>(m(),T(U,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(k,{gutter:20},{default:a(()=>[l(g,{span:12},{default:a(()=>[l(d,{label:"所在校区",prop:"campusId"},{default:a(()=>[l(C,{modelValue:t.campusId,"onUpdate:modelValue":e[7]||(e[7]=o=>t.campusId=o),placeholder:"请选择校区",style:{width:"100%"},onChange:ne},{default:a(()=>[(m(!0),b(N,null,B(W.value,o=>(m(),T(U,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(g,{span:12},{default:a(()=>[l(d,{label:"关联课程"},{default:a(()=>[l(C,{modelValue:t.courseId,"onUpdate:modelValue":e[8]||(e[8]=o=>t.courseId=o),placeholder:"搜索或选择课程",style:{width:"100%"},filterable:"",remote:"","remote-method":ue,clearable:""},{default:a(()=>[(m(!0),b(N,null,B(w.value,o=>(m(),T(U,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(k,{gutter:20},{default:a(()=>[l(g,{span:8},{default:a(()=>[l(d,{label:"售价 (¥)",prop:"price"},{default:a(()=>[l(G,{modelValue:t.price,"onUpdate:modelValue":e[9]||(e[9]=o=>t.price=o),precision:2,step:1,min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(g,{span:8},{default:a(()=>[l(d,{label:"原价 (¥)",prop:"originalPrice"},{default:a(()=>[l(G,{modelValue:t.originalPrice,"onUpdate:modelValue":e[10]||(e[10]=o=>t.originalPrice=o),precision:2,step:1,min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(g,{span:8},{default:a(()=>[l(d,{label:"新旧程度",prop:"conditionLevel"},{default:a(()=>[l(C,{modelValue:t.conditionLevel,"onUpdate:modelValue":e[11]||(e[11]=o=>t.conditionLevel=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(m(),b(N,null,B(10,o=>l(U,{key:o,label:o+"成新",value:o},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(d,{label:"品相详情"},{default:a(()=>[u("div",Ee,[l(P,{modelValue:t.hasNotes,"onUpdate:modelValue":e[12]||(e[12]=o=>t.hasNotes=o),"true-label":1,"false-label":0},{default:a(()=>[...e[29]||(e[29]=[n(" 有笔记 ",-1)])]),_:1},8,["modelValue"]),l(P,{modelValue:t.hasHighlight,"onUpdate:modelValue":e[13]||(e[13]=o=>t.hasHighlight=o),"true-label":1,"false-label":0},{default:a(()=>[...e[30]||(e[30]=[n(" 有划线 ",-1)])]),_:1},8,["modelValue"]),l(P,{modelValue:t.hasMissingPages,"onUpdate:modelValue":e[14]||(e[14]=o=>t.hasMissingPages=o),"true-label":1,"false-label":0},{default:a(()=>[...e[31]||(e[31]=[n(" 有缺页 ",-1)])]),_:1},8,["modelValue"]),l(P,{modelValue:t.hasWaterStains,"onUpdate:modelValue":e[15]||(e[15]=o=>t.hasWaterStains=o),"true-label":1,"false-label":0},{default:a(()=>[...e[32]||(e[32]=[n(" 有水渍 ",-1)])]),_:1},8,["modelValue"])]),u("div",ze,[l(f,null,{default:a(()=>[l(h(he))]),_:1}),e[33]||(e[33]=n(" 请如实勾选，虚假描述将影响您的信用评分 ",-1))])]),_:1}),l(d,{label:"适用课程",prop:"course"},{default:a(()=>[l(c,{modelValue:t.course,"onUpdate:modelValue":e[16]||(e[16]=o=>t.course=o),placeholder:"请输入适用课程名称（可选）"},null,8,["modelValue"])]),_:1}),l(d,{label:"教材图片",prop:"images"},{default:a(()=>[l(ie,{action:"#","list-type":"picture-card","auto-upload":!1,"file-list":t.images,"on-change":Y,"on-remove":Z,"on-preview":ee,multiple:"",limit:5},{tip:a(()=>[...e[34]||(e[34]=[u("div",{class:"el-upload__tip"}," 最多上传5张图片，建议包含封面、版权页及内页图 ",-1)])]),default:a(()=>[l(f,null,{default:a(()=>[l(h(Ie))]),_:1})]),_:1},8,["file-list"])]),_:1}),l(de,{modelValue:q.value,"onUpdate:modelValue":e[17]||(e[17]=o=>q.value=o),title:"图片预览",width:"40%"},{default:a(()=>[u("img",{src:K.value,alt:"预览图片",style:{width:"100%",display:"block"}},null,8,Te)]),_:1},8,["modelValue"]),l(d,{label:"详细描述",prop:"description"},{default:a(()=>[l(c,{modelValue:t.description,"onUpdate:modelValue":e[18]||(e[18]=o=>t.description=o),type:"textarea",placeholder:"请详细描述教材的成色、有无笔记划线等信息",rows:5},null,8,["modelValue"])]),_:1}),l(d,null,{default:a(()=>[l(_,{type:"primary",size:"large",onClick:ae,loading:S.value},{default:a(()=>[...e[35]||(e[35]=[n(" 立即发布 ",-1)])]),_:1},8,["loading"]),l(_,{size:"large",onClick:e[19]||(e[19]=o=>s.$router.back())},{default:a(()=>[...e[36]||(e[36]=[n("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})])}}},Ae=me($e,[["__scopeId","data-v-a0353439"]]);export{Ae as default};
