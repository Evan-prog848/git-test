-- =====================================================
-- 删除ID为31-51的用户及相关数据
-- 执行日期: 2026-01-29
-- 说明: 按照外键依赖关系，先删除子表数据，最后删除用户表数据
-- =====================================================

USE textbook_trading;

-- 开始事务
START TRANSACTION;

-- =====================================================
-- 1. 删除教材图片表中的相关数据
-- =====================================================
DELETE FROM `textbook_image`
WHERE `textbook_id` IN (
    SELECT `id` FROM `textbook` WHERE `user_id` BETWEEN 31 AND 51
);

-- =====================================================
-- 2. 删除收藏表中的相关数据
-- =====================================================
DELETE FROM `favorite`
WHERE `user_id` BETWEEN 31 AND 51
   OR `textbook_id` IN (
       SELECT `id` FROM `textbook` WHERE `user_id` BETWEEN 31 AND 51
   );

-- =====================================================
-- 3. 删除浏览历史表中的相关数据
-- =====================================================
DELETE FROM `browse_history`
WHERE `user_id` BETWEEN 31 AND 51
   OR `textbook_id` IN (
       SELECT `id` FROM `textbook` WHERE `user_id` BETWEEN 31 AND 51
   );

-- =====================================================
-- 4. 删除评价表中的相关数据
-- =====================================================
DELETE FROM `review`
WHERE `from_user_id` BETWEEN 31 AND 51
   OR `to_user_id` BETWEEN 31 AND 51;

-- =====================================================
-- 5. 删除消息表中的相关数据
-- =====================================================
DELETE FROM `message`
WHERE `from_user_id` BETWEEN 31 AND 51
   OR `to_user_id` BETWEEN 31 AND 51;

-- =====================================================
-- 6. 删除关注表中的相关数据
-- =====================================================
DELETE FROM `follow`
WHERE `user_id` BETWEEN 31 AND 51
   OR `follow_user_id` BETWEEN 31 AND 51;

-- =====================================================
-- 7. 删除订单表中的相关数据
-- =====================================================
DELETE FROM `orders`
WHERE `seller_id` BETWEEN 31 AND 51
   OR `buyer_id` BETWEEN 31 AND 51;

-- =====================================================
-- 8. 删除求购表中的相关数据
-- =====================================================
DELETE FROM `wanted`
WHERE `user_id` BETWEEN 31 AND 51;

-- =====================================================
-- 9. 删除教材表中的相关数据
-- =====================================================
DELETE FROM `textbook`
WHERE `user_id` BETWEEN 31 AND 51;

-- =====================================================
-- 10. 最后删除用户表中的数据
-- =====================================================
DELETE FROM `user`
WHERE `id` BETWEEN 31 AND 51;

-- 提交事务
COMMIT;

-- =====================================================
-- 验证删除结果
-- =====================================================
SELECT CONCAT('成功删除ID为31-51的用户（共', COUNT(*), '条）') AS result
FROM `user`
WHERE `id` BETWEEN 31 AND 51;

SELECT '如果上述查询返回0条记录，说明删除成功！' AS message;
